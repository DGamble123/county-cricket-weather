<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>County Cricket Ground Weather</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 28px 20px;
      color: #111827;
    }

    h1 {
      text-align: center;
      font-weight: 500;
      margin-bottom: 6px;
    }

    .subtitle {
      text-align: center;
      color: #6b7280;
      margin-bottom: 22px;
      font-size: 0.95rem;
    }

    #map-wrapper {
      position: relative;
      max-width: 1000px;
      margin: 0 auto;
    }

    #map {
      height: 72vh;
      border-radius: 14px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      overflow: hidden;
    }

    /* Make the map a quiet background */
    .leaflet-tile {
      filter: grayscale(60%) brightness(103%);
    }

    /* Halo marker styles */
    .halo-marker {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: #1f2937;
      border: 2px solid #ffffff;
      box-shadow: 0 0 0 10px rgba(0,0,0,0);
    }

    .halo-good {
      box-shadow: 0 0 0 11px rgba(34, 197, 94, 0.28),
                  0 6px 18px rgba(0,0,0,0.15);
    }

    .halo-avg {
      box-shadow: 0 0 0 11px rgba(234, 179, 8, 0.28),
                  0 6px 18px rgba(0,0,0,0.15);
    }

    .halo-poor {
      box-shadow: 0 0 0 12px rgba(239, 68, 68, 0.32),
                  0 6px 18px rgba(0,0,0,0.15);
    }

    /* Legend */
    .legend {
      position: absolute;
      bottom: 14px;
      right: 14px;
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(4px);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 0.85rem;
      line-height: 1.4;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #1f2937;
    }

    .legend-good { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.35); }
    .legend-avg  { box-shadow: 0 0 0 6px rgba(234, 179, 8, 0.35); }
    .legend-poor { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0.4); }

  </style>
</head>

<body>

<h1>County Cricket Weather (Test)</h1>
<div class="subtitle">Live conditions across England & Wales</div>

<div id="map-wrapper">
  <div id="map"></div>

  <div class="legend">
    <div class="legend-item">
      <span class="legend-dot legend-good"></span> Good (dry, playable)
    </div>
    <div class="legend-item">
      <span class="legend-dot legend-avg"></span> At risk
    </div>
    <div class="legend-item">
      <span class="legend-dot legend-poor"></span> Poor (rain expected)
    </div>
  </div>
</div>

<script>
/* ------------------- DATA ------------------- */
const grounds = [
  { name: "Lord’s", county: "Middlesex", lat: 51.5294, lon: -0.1727 },
  { name: "The Oval", county: "Surrey", lat: 51.4826, lon: -0.0077 },
  { name: "Edgbaston", county: "Warwickshire", lat: 52.4559, lon: -1.9040 },
  { name: "Trent Bridge", county: "Nottinghamshire", lat: 52.9368, lon: -1.1332 },
  { name: "Headingley", county: "Yorkshire", lat: 53.8173, lon: -1.5825 },
  { name: "Old Trafford", county: "Lancashire", lat: 53.4564, lon: -2.2876 },
  { name: "Sophia Gardens", county: "Glamorgan", lat: 51.4813, lon: -3.1800 },
  { name: "Bristol", county: "Gloucestershire", lat: 51.4569, lon: -2.6091 },
  { name: "Taunton", county: "Somerset", lat: 51.0135, lon: -3.1067 },
  { name: "Chelmsford", county: "Essex", lat: 51.7355, lon: 0.4685 },
  { name: "Northampton", county: "Northamptonshire", lat: 52.2362, lon: -0.9038 },
  { name: "Derby", county: "Derbyshire", lat: 52.9187, lon: -1.4700 },
  { name: "Hove", county: "Sussex", lat: 50.8360, lon: -0.1800 },
  { name: "Grace Road", county: "Leicestershire", lat: 52.6493, lon: -1.0976 },
  { name: "New Road", county: "Worcestershire", lat: 52.1920, lon: -2.2180 },
  { name: "Riverside", county: "Durham", lat: 54.8510, lon: -1.5720 },
  { name: "Rose Bowl", county: "Hampshire", lat: 50.9050, lon: -1.3920 },
  { name: "Canterbury", county: "Kent", lat: 51.2798, lon: 1.0871 }
];

/* ------------------- MAP (STATIC, CLEAN) ------------------- */
const ewBounds = [
  [50.1, -5.8],
  [55.4,  1.6]
];

const map = L.map("map", {
  zoomControl: false,
  dragging: false,
  scrollWheelZoom: false,
  doubleClickZoom: false,
  boxZoom: false,
  keyboard: false,
  touchZoom: false
});

map.fitBounds(ewBounds, { padding: [10, 10] });

L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png",
  { attribution: "&copy; OpenStreetMap & CARTO" }
).addTo(map);

/* ------------------- WEATHER ------------------- */
async function getWeather(lat, lon) {
  const url =
    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
    `&current_weather=true&hourly=precipitation&timezone=Europe/London`;

  const res = await fetch(url);
  if (!res.ok) throw new Error("Weather fetch failed");
  return await res.json();
}

function classifyConditions(cw, hourly) {
  const rain = hourly?.precipitation?.[0] ?? 0;
  if (rain > 0) return "poor";
  if (cw.temperature < 12 || cw.windspeed > 30) return "avg";
  return "good";
}

/* ------------------- MARKERS ------------------- */
async function addGroundMarkers() {
  for (const g of grounds) {
    const icon = L.divIcon({
      html: `<div class="halo-marker"></div>`,
      iconSize: [14, 14],
      iconAnchor: [7, 7]
    });

    const marker = L.marker([g.lat, g.lon], { icon }).addTo(map);
    marker.bindPopup(`<b>${g.name}</b><br>${g.county}<br>Loading…`);

    try {
      const data = await getWeather(g.lat, g.lon);
      const rating = classifyConditions(data.current_weather, data.hourly);
      const rain = Math.round((data.hourly?.precipitation?.[0] ?? 0) * 10) / 10;

      setTimeout(() => {
        const el = marker.getElement()?.querySelector(".halo-marker");
        if (!el) return;
        el.classList.add(
          rating === "good" ? "halo-good" :
          rating === "poor" ? "halo-poor" : "halo-avg"
        );
      }, 0);

      marker.setPopupContent(`
        <b>${g.name}</b><br>
        ${g.county}<br><br>
        <b>${data.current_weather.temperature}°C</b><br>
        Wind: ${data.current_weather.windspeed} km/h<br>
        Rain (next hour): ${rain} mm
      `);

    } catch {
      marker.setPopupContent(`<b>${g.name}</b><br>${g.county}<br>Weather unavailable`);
    }
  }
}

addGroundMarkers();
</script>

</body>
</html>
