<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>County Cricket Ground Weather</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 20px;
    }

    h1 {
      text-align: center;
    }

    #map {
      height: 75vh;
      max-width: 1000px;
      margin: 0 auto;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    /* Optional polish: slightly soften the map tiles */
    .leaflet-tile {
      filter: grayscale(20%) brightness(98%);
    }

    /* Halo marker styles */
    .halo-marker {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: #1f2937;
      border: 2px solid #ffffff;
      box-shadow: 0 0 0 10px rgba(0,0,0,0);
    }

    .halo-good {
      box-shadow: 0 0 0 10px rgba(34, 197, 94, 0.25),
                  0 6px 18px rgba(0,0,0,0.12);
    }

    .halo-avg {
      box-shadow: 0 0 0 10px rgba(234, 179, 8, 0.25),
                  0 6px 18px rgba(0,0,0,0.12);
    }

    .halo-poor {
      box-shadow: 0 0 0 10px rgba(239, 68, 68, 0.25),
                  0 6px 18px rgba(0,0,0,0.12);
    }
  </style>
</head>

<body>

<h1>County Cricket Ground Weather</h1>
<div id="map"></div>

<script>
/* ------------------- DATA ------------------- */
const grounds = [
  { name: "Lord’s", county: "Middlesex", lat: 51.5294, lon: -0.1727 },
  { name: "The Oval", county: "Surrey", lat: 51.4826, lon: -0.0077 },
  { name: "Edgbaston", county: "Warwickshire", lat: 52.4559, lon: -1.9040 },
  { name: "Trent Bridge", county: "Nottinghamshire", lat: 52.9368, lon: -1.1332 },
  { name: "Headingley", county: "Yorkshire", lat: 53.8173, lon: -1.5825 },
  { name: "Old Trafford", county: "Lancashire", lat: 53.4564, lon: -2.2876 },
  { name: "Sophia Gardens", county: "Glamorgan", lat: 51.4813, lon: -3.1800 },
  { name: "Bristol", county: "Gloucestershire", lat: 51.4569, lon: -2.6091 },
  { name: "Taunton", county: "Somerset", lat: 51.0135, lon: -3.1067 },
  { name: "Chelmsford", county: "Essex", lat: 51.7355, lon: 0.4685 },
  { name: "Northampton", county: "Northamptonshire", lat: 52.2362, lon: -0.9038 },
  { name: "Derby", county: "Derbyshire", lat: 52.9187, lon: -1.4700 },
  { name: "Hove", county: "Sussex", lat: 50.8360, lon: -0.1800 },
  { name: "Grace Road", county: "Leicestershire", lat: 52.6493, lon: -1.0976 },
  { name: "New Road", county: "Worcestershire", lat: 52.1920, lon: -2.2180 },
  { name: "Riverside", county: "Durham", lat: 54.8510, lon: -1.5720 },
  { name: "Rose Bowl", county: "Hampshire", lat: 50.9050, lon: -1.3920 },
  { name: "Canterbury", county: "Kent", lat: 51.2798, lon: 1.0871 }
];

/* ------------------- MAP (STATIC: ENGLAND & WALES) ------------------- */
// England & Wales bounding box
const ewBounds = [
  [49.9, -6.4],  // SW (Cornwall / Isles of Scilly)
  [55.9,  2.1]   // NE (Northumberland coast)
];

const map = L.map("map", {
  zoomControl: false,
  dragging: false,
  scrollWheelZoom: false,
  doubleClickZoom: false,
  boxZoom: false,
  keyboard: false,
  touchZoom: false
});

map.fitBounds(ewBounds);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 18,
  attribution: "&copy; OpenStreetMap contributors"
}).addTo(map);

/* ------------------- WEATHER ------------------- */
async function getWeather(lat, lon) {
  const url =
    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
    `&current_weather=true&hourly=precipitation&timezone=Europe/London`;

  for (let attempt = 0; attempt < 2; attempt++) {
    const res = await fetch(url);

    if (res.status === 429 || res.status === 503) {
      await new Promise(r => setTimeout(r, 500 * (attempt + 1)));
      continue;
    }

    if (!res.ok) {
      const text = await res.text().catch(() => "");
      throw new Error(`HTTP ${res.status} ${res.statusText} ${text}`);
    }

    return await res.json();
  }

  throw new Error("Weather API retry failed");
}

function classifyConditions(cw, hourly) {
  const temp = cw.temperature;               // °C
  const wind = cw.windspeed;                 // km/h
  const rain = hourly?.precipitation?.[0] ?? 0; // mm next hour

  // Cricket-first:
  if (rain > 0) return "poor";
  if (temp < 12 || wind > 30) return "avg";
  return "good";
}

/* ------------------- MARKERS ------------------- */
async function addGroundMarkers() {
  for (const g of grounds) {
    const icon = L.divIcon({
      className: "",
      html: `<div class="halo-marker"></div>`,
      iconSize: [14, 14],
      iconAnchor: [7, 7]
    });

    const marker = L.marker([g.lat, g.lon], { icon }).addTo(map);

    // Popups still work even though the map is static
    marker.bindPopup(`<b>${g.name}</b><br>${g.county}<br>Loading weather…`);

    try {
      const data = await getWeather(g.lat, g.lon);
      const cw = data.current_weather;

      const rating = classifyConditions(cw, data.hourly);
      const rain = Math.round((data.hourly?.precipitation?.[0] ?? 0) * 10) / 10;

      // Ensure marker DOM exists before adding halo class
      setTimeout(() => {
        const el = marker.getElement()?.querySelector(".halo-marker");
        if (!el) return;

        el.classList.add(
          rating === "good" ? "halo-good" :
          rating === "poor" ? "halo-poor" : "halo-avg"
        );
      }, 0);

      marker.setPopupContent(`
        <b>${g.name}</b><br>
        ${g.county}<br><br>
        <b>${cw.temperature}°C</b><br>
        Wind: ${cw.windspeed} km/h<br>
        Rain (next hour): ${rain} mm<br>
        Updated: ${cw.time}
      `);

    } catch (e) {
      console.error("Weather error:", g.name, e);
      marker.setPopupContent(
        `<b>${g.name}</b><br>${g.county}<br><br>
         Weather unavailable<br><small>${e.message}</small>`
      );
    }

    // Small delay to reduce chance of rate limiting
    await new Promise(r => setTimeout(r, 120));
  }
}

addGroundMarkers();
</script>

</body>
</html>
